from supervised import *

import pytest
import pandas as pd
import numpy as np
from ml_prepare import ML_prepare


def test_valid_section_value():
    section = "nocardia"
    with pytest.raises(ValueError):
        choose_k_value(section, 'SV_label', 5)

def test_valid_label_value():
    label = "SV"
    with pytest.raises(ValueError):
        choose_k_value('all', label, 5)

def test_create_score_list_Knn_result():
    score_list_test = [[0.4, 0.0, 0.8, 0.5555555555555556], [0.8333333333333334, 0.0, 0.5714285714285714, 0.5], [1.0, 0.3333333333333333, 0.5, 0.5555555555555556], [0.25, 0.4, 0.6666666666666666, 0.5], [0.75, 0.0, 0.7777777777777778, 0.5555555555555556], [0.0, 0.0, 0.7, 0.4117647058823529], [0.09090909090909091, 0.5, 0.5161290322580645, 0.44285714285714284], [0.14285714285714285, 0.3181818181818182, 0.696969696969697, 0.463768115942029], [0.125, 0.43333333333333335, 0.6774193548387096, 0.5072463768115942], [0.1875, 0.3333333333333333, 0.6785714285714286, 0.4411764705882353], [0.25, 0.2692307692307692, 0.6923076923076923, 0.4264705882352941], [0.0, 0.2647058823529412, 0.7857142857142857, 0.45588235294117646], [0.0, 0.25, 0.7777777777777778, 0.4444444444444444], [0.3333333333333333, 0.8, 0.42857142857142855, 0.5], [0.5, 0.16666666666666666, 1.0, 0.6111111111111112], [0.6666666666666666, 0.0, 0.8888888888888888, 0.5555555555555556], [0.6666666666666666, 0.0, 0.6666666666666666, 0.4444444444444444], [0.0, 0.6666666666666666, 0.7777777777777778, 0.6111111111111112], [0.1111111111111111, 0.5185185185185185, 0.5172413793103449, 0.4189189189189189], [0.3684210526315789, 0.21428571428571427, 0.6538461538461539, 0.410958904109589], [0.17391304347826086, 0.2857142857142857, 0.7272727272727273, 0.3835616438356164], [0.35, 0.3333333333333333, 0.5806451612903226, 0.4444444444444444], [0.25, 0.09523809523809523, 0.5806451612903226, 0.3472222222222222],
    [0.17647058823529413, 0.7368421052631579, 0.5, 0.4861111111111111], [0.0, 0.8, 0.5714285714285714, 0.4444444444444444], [0.5, 0.8333333333333334, 0.5, 0.6111111111111112], [0.5, 0.3333333333333333, 0.625, 0.5], [1.0, 0.42857142857142855, 0.125, 0.3888888888888889], [1.0, 0.625, 0.375, 0.5555555555555556], [0.25, 0.7142857142857143, 0.5, 0.5294117647058824], [0.25, 0.5666666666666667, 0.42857142857142855, 0.45714285714285713], [0.25, 0.48484848484848486, 0.5, 0.4492753623188406], [0.3333333333333333, 0.5806451612903226, 0.4827586206896552, 0.5072463768115942], [0.15384615384615385, 0.4, 0.56, 0.4117647058823529], [0.3, 0.4473684210526316, 0.6, 0.47058823529411764], [0.5454545454545454, 0.5789473684210527, 0.7894736842105263, 0.6323529411764706], [0.16666666666666666, 0.6666666666666666, 1.0, 0.6111111111111112], [0.25, 0.5714285714285714, 0.7142857142857143, 0.5555555555555556], [1.0, 0.5714285714285714, 0.875, 0.7777777777777778], [0.6666666666666666, 0.2857142857142857, 0.75, 0.5555555555555556], [0.5, 0.5555555555555556, 0.8571428571428571, 0.6666666666666666], [0.0, 0.8571428571428571, 0.8333333333333334, 0.6111111111111112], [0.2608695652173913, 0.52, 0.34615384615384615, 0.3783783783783784], [0.3, 0.5, 0.5238095238095238, 0.4520547945205479], [0.4375, 0.3939393939393939, 0.5833333333333334, 0.4657534246575342], [0.3684210526315789, 0.5, 0.37037037037037035, 0.4166666666666667], [0.14285714285714285, 0.4117647058823529, 0.4117647058823529, 0.3333333333333333], [0.2, 0.6666666666666666, 0.36, 0.4305555555555556]]
    delay_lst = [*range(0, 18, 3)]
    sections = ['all','total_counts', 'filaments', 'various']
    labels = ['SV_label', 'SVI_label']
    k = 9
    score_lst = create_score_list_Knn(labels, sections, delay_lst, k)
    assert score_lst == score_list_test

def create_score_list_valid_k_value():
    delay_lst = [*range(0, 18, 3)]
    sections = ['all','total_counts', 'filaments', 'various']
    labels = ['SV_label', 'SVI_label']
    k = -1
    with pytest.raises(ValueError): score_lst = create_score_list(labels, sections, delay_lst, k)

def test_k_max_value():
    k_max = -5
    X_train= pd.DataFrame((np.random.random((2, 4))))
    y_train= pd.DataFrame((np.random.random((2, 1))))
    X_test= pd.DataFrame((np.random.random((2, 4))))
    y_test= pd.DataFrame((np.random.random((2, 1))))
    with pytest.raises(ValueError):
        check_K_values(k_max, X_train, y_train, X_test, y_test)

def test_score_by_label():
    y_test = pd.Series(['good', 'bad', 'reasonable'])
    y_predict = ['good', 'bad', 'reasonable']
    score = [1, 1, 1]
    assert score == score_by_label (y_test, y_predict)

def test_create_score_list_SVC_result():
    score_list_test = [[0.2, 0.3333333333333333, 0.7, 0.5], [0.5, 0.0, 0.5714285714285714, 0.3888888888888889], [0.25, 0.3333333333333333, 0.0, 0.16666666666666666],
        [0.5, 0.4, 0.2222222222222222, 0.3333333333333333], [0.5, 0.2, 0.2222222222222222, 0.2777777777777778], [0.6666666666666666, 0.25, 0.7, 0.5882352941176471], [0.09090909090909091, 0.39285714285714285, 0.5806451612903226, 0.42857142857142855], [0.0, 0.22727272727272727, 0.8787878787878788, 0.4927536231884058], [0.0, 0.43333333333333335, 0.5161290322580645, 0.42028985507246375], [0.125, 0.3333333333333333, 0.7857142857142857, 0.47058823529411764], [0.0, 0.46153846153846156, 0.7307692307692307, 0.45588235294117646], [0.0, 0.23529411764705882, 0.5357142857142857, 0.3382352941176471], [0.0, 0.0, 0.8888888888888888, 0.4444444444444444], [0.3333333333333333, 0.4, 0.42857142857142855, 0.3888888888888889], [0.5, 0.3333333333333333, 0.625, 0.5], [0.6666666666666666, 0.0, 0.5555555555555556, 0.3888888888888889], [0.0, 0.16666666666666666, 0.6666666666666666, 0.3888888888888889], [0.3333333333333333, 0.5, 0.6666666666666666, 0.5555555555555556], [0.2222222222222222, 0.3333333333333333, 0.41379310344827586, 0.33783783783783783], [0.10526315789473684, 0.2857142857142857, 0.6153846153846154, 0.3561643835616438], [0.043478260869565216, 0.6428571428571429, 0.5909090909090909, 0.4383561643835616], [0.25, 0.42857142857142855, 0.5161290322580645, 0.4166666666666667], [0.25, 0.47619047619047616, 0.5483870967741935, 0.4444444444444444], [0.29411764705882354, 0.3157894736842105, 0.5, 0.4027777777777778], [0.5, 0.6, 0.2857142857142857, 0.4444444444444444], [0.5, 0.6666666666666666, 0.25, 0.4444444444444444], [0.5, 0.6666666666666666, 0.25, 0.4444444444444444], [0.6666666666666666, 0.14285714285714285, 0.5, 0.3888888888888889], [0.5, 0.625, 0.0, 0.3333333333333333], [0.25, 0.42857142857142855, 0.5, 0.4117647058823529], [0.0, 0.8, 0.5, 0.5428571428571428], [0.0, 0.696969696969697, 0.5416666666666666, 0.5217391304347826], [0.0, 0.7096774193548387, 0.6206896551724138,
        0.5797101449275363], [0.0, 0.7, 0.6, 0.5294117647058824], [0.1, 0.7894736842105263, 0.55, 0.6176470588235294], [0.09090909090909091, 0.6052631578947368, 0.631578947368421, 0.5294117647058824], [0.16666666666666666, 0.3333333333333333, 1.0, 0.5], [0.25, 0.42857142857142855, 0.7142857142857143, 0.5], [0.6666666666666666, 0.42857142857142855, 0.875, 0.6666666666666666], [0.6666666666666666, 0.2857142857142857, 1.0, 0.6666666666666666], [0.5, 0.4444444444444444, 0.8571428571428571, 0.6111111111111112], [0.4, 0.5714285714285714, 0.6666666666666666, 0.5555555555555556], [0.17391304347826086, 0.8, 0.38461538461538464, 0.4594594594594595], [0.1, 0.5625, 0.38095238095238093, 0.3835616438356164], [0.25, 0.5454545454545454, 0.5, 0.4657534246575342], [0.2631578947368421, 0.6923076923076923, 0.4444444444444444, 0.4861111111111111], [0.23809523809523808, 0.6470588235294118, 0.35294117647058826, 0.4583333333333333], [0.4, 0.5925925925925926, 0.56, 0.5277777777777778]]
    delay_lst = [*range(0, 18, 3)]
    sections = ['all','total_counts', 'filaments', 'various']
    labels = ['SV_label', 'SVI_label']
    score_lst = create_score_list_SVC(labels, sections, delay_lst)
    assert score_lst == score_list_test